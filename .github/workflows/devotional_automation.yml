name: Devotional Hindi Automation

on:
  schedule:
    # 15:00 UTC = 10:00 AM EST (Morning Scroll)
    # 20:00 UTC = 03:00 PM EST (Afternoon Break)
    # 01:00 UTC = 08:00 PM EST (Prime Time / Viral Window)
    - cron: '0 1,15,20 * * *'
  workflow_dispatch: # Manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Need to push changes

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Random Delay (USA Reach Optimization)
      # Sleeps for a random time between 1 and 20 minutes (1200 seconds)
      # This makes uploads look organic rather than automated at :00 exactly.
      run: |
        DELAY=$(( ( RANDOM % 1200 )  + 1 ))
        echo "Waiting for $DELAY seconds to simulate organic upload..."
        sleep $DELAY

    - name: Install dependencies
      run: |
        # Free up disk space on GitHub runners
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get clean
        
        sudo apt-get update
        sudo apt-get install -y ffmpeg libegl1 libgl1
        pip install --upgrade pip setuptools wheel
        pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
        pip install "numpy<2" cython
        pip install pyworld --no-build-isolation
        pip install requests pillow click imageio-ffmpeg skia-python uharfbuzz
        pip install torch==2.5.1 torchvision==0.20.1 torchaudio==2.5.1 --index-url https://download.pytorch.org/whl/cpu
        pip install "transformers<4.42"
        pip install TTS --no-build-isolation
        pip cache purge

    - name: Decode YouTube Token
      env:
        TOKEN_BASE64: ${{ secrets.DEVOTIONAL_TOKEN_PICKLE_BASE64 }}
      run: |
        echo $TOKEN_BASE64 | base64 --decode > token_devotional.pickle

    - name: Create Client Secrets File
      env:
        CLIENT_SECRETS: ${{ secrets.YOUTUBE_CLIENT_SECRETS }}
      run: |
        echo $CLIENT_SECRETS > client_secrets.json

    - name: Generate Video
      env:
        COQUI_TOS_AGREED: "1"
      run: |
        python scripts/devotional_hindi/devotional_hindi_video.py --limit 1

    - name: Upload and Cleanup
      env:
        BHAKTI_INSTAGRAM_ACCESS_TOKEN: ${{ secrets.BHAKTI_INSTAGRAM_ACCESS_TOKEN }}
        BHAKTI_FACEBOOK_ACCESS_TOKEN: ${{ secrets.BHAKTI_FACEBOOK_ACCESS_TOKEN }}
        IG_BUSINESS_ID: ${{ secrets.IG_BUSINESS_ID_BHAKTI }}
        FB_PAGE_ID: ${{ secrets.FB_PAGE_ID_BHAKTI }}
      run: |
        python scripts/devotional_hindi/upload_devotional_video.py

    - name: Commit and Push Changes
      run: |
        git config --local user.email "11308641+cssmatter@users.noreply.github.com"
        git config --local user.name "cssmatter"
        
        if git diff --quiet data/DevotionalHindiQuotes/data.json && git diff --staged --quiet data/DevotionalHindiQuotes/data.json; then
          echo "No changes to commit"
        else
          # Stash local changes
          git stash
          
          # Pull latest changes from remote
          git pull --rebase origin main
          
          # Apply stashed changes
          git stash pop
          
          # Add and commit the changes
          git add data/DevotionalHindiQuotes/data.json
          git commit -m "Auto-cleanup published devotional quote"
          
          # Push to remote
          git push
        fi